name: Keep Streamlit App Alive

# This workflow pings the Streamlit app every 4 hours to prevent it from sleeping
# App URL: https://ngocson-tss.streamlit.app
# Fixes applied:
# - Uses correct app-specific Streamlit URL
# - Improved error handling and diagnostics  
# - Supports manual URL override via STREAMLIT_APP_URL secret

on:
  schedule:
    # Run every 4 hours (conservative interval to respect ToS)
    - cron: '0 */4 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ping Streamlit App
      run: |
        echo "üîÑ Pinging TSS Converter App to keep it alive..."
        
        # Set app URL - use GitHub secret if available, otherwise use inferred URL
        if [ -n "${{ secrets.STREAMLIT_APP_URL }}" ]; then
          APP_URL="${{ secrets.STREAMLIT_APP_URL }}"
          echo "üîó Using configured URL from secrets: $APP_URL"
        else
          # Use the known correct URL for this specific app
          APP_URL="https://ngocson-tss.streamlit.app"
          echo "üîó Using app-specific URL: $APP_URL"
        fi
        
        # Perform HTTP request with proper headers
        response=$(curl -s -o /dev/null -w "%{http_code}" \
          --connect-timeout 30 \
          --max-time 60 \
          --retry 3 \
          --retry-delay 5 \
          --user-agent "GitHub-Actions-KeepAlive/1.0 (TSS-Converter-Monitoring)" \
          "$APP_URL")
        
        # Check response status
        echo "üìä HTTP Response Code: $response"
        
        if [ "$response" = "200" ]; then
          echo "‚úÖ App is alive and responding! HTTP Status: $response"
          echo "‚úÖ Ping successful at $(date -u)"
        elif [ "$response" = "000" ]; then
          echo "‚ùå Failed to connect to app (timeout or network error)"
          echo "üîç This could mean:"
          echo "   - App is not deployed yet"
          echo "   - App URL is incorrect"
          echo "   - Network connectivity issues"
          echo "   - App is sleeping and taking too long to wake up"
          exit 1
        elif [ "$response" = "404" ]; then
          echo "‚ùå App not found (404) - URL might be incorrect"
          echo "üîç Expected URL: $APP_URL"
          echo "   - Check if the app is deployed to Streamlit Cloud"
          echo "   - Verify the repository name matches the app URL"
          exit 1
        elif [[ "$response" =~ ^[45][0-9][0-9]$ ]]; then
          echo "‚ö†Ô∏è  App responded with HTTP Status: $response"
          echo "‚ÑπÔ∏è  This might be temporary - app could be:"
          echo "   - Starting up (normal for sleeping apps)"
          echo "   - Experiencing temporary issues"
          echo "   - Under maintenance"
          echo "üîÑ Not failing the job - will retry on next scheduled run"
        else
          echo "‚úÖ App responded with HTTP Status: $response (acceptable)"
          echo "‚ÑπÔ∏è  App is responding, status $response is within normal range"
        fi
        
        echo "üìä Keep-alive ping completed at $(date -u)"

    - name: Log Status
      if: always()
      run: |
        echo "üìã Job Status Summary:"
        echo "- Workflow: Keep Streamlit App Alive"
        echo "- Trigger: ${{ github.event_name }}"
        echo "- Time: $(date -u)"
        echo "- Repository: ${{ github.repository }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "‚úÖ Keep-alive successful"
        else
          echo "‚ùå Keep-alive failed - check app status"
        fi

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: keep-alive
    if: failure()
    
    steps:
    - name: Failure Notification
      run: |
        echo "üö® Keep-Alive Failed!"
        echo "The TSS Converter Streamlit app may be experiencing issues."
        echo "Please check the app manually: https://ngocson-tss.streamlit.app"
        echo "Time: $(date -u)"
        echo "This might be temporary - the app should auto-recover."